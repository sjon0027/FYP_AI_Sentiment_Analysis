{
  "$schema": "https://vega.github.io/schema/vega-lite/v6.json",
  "description": "A diverging stacked bar chart for sentiments towards a set of eight questions, displayed as percentages with neutral responses straddling the 0% mark",
  "data": {
    "url": "data/likert_responses_categorised.json",
    "format": {
      "type": "json"
    }
  },
  "params": [
    {
      "name": "selectedQuestion",
      "value": "All",
      "bind": {
        "input": "select",
        "options": [
          "All",
          "Agree",
          "Disagree",
          "Neutral",
          "Positive",
          "Negative",
          "Privacy",
          "Data",
          "Accountability",
          "Transparency",
          "Bias"
        ],
        "labels": [
          "All",
          "Agree on Average",
          "Disagree on Average",
          "Neutral Statements",
          "Positive Statements",
          "Negative Statements",
          "Privacy",
          "Data Misuse",
          "Accountability",
          "Transparency",
          "Bias"
        ],
        "name": "Category: "
      }
    }
  ],
  "transform": [
    {
      "filter": "selectedQuestion === 'All' || (selectedQuestion === 'Agree' && datum.avg_score > 3) || (selectedQuestion === 'Disagree' && datum.avg_score <= 3) || (selectedQuestion === 'Neutral' && datum.sentiment == 'neutral') || (selectedQuestion === 'Positive' && datum.sentiment == 'positive') || (selectedQuestion === 'Negative' && datum.sentiment == 'negative') || (selectedQuestion === 'Privacy' && datum.category == 'privacy') || (selectedQuestion === 'Data' && datum.category == 'data_misuse') || (selectedQuestion === 'Accountability' && datum.category == 'accountability') || (selectedQuestion === 'Transparency' && datum.category == 'transparency') || (selectedQuestion === 'Bias' && datum.category == 'bias')"
    },
    {
      "calculate": "if(datum.type === 'Strongly disagree',-2,0) + if(datum.type==='Disagree',-1,0) + if(datum.type =='Neutral',0,0) + if(datum.type ==='Agree',1,0) + if(datum.type ==='Strongly agree',2,0)",
      "as": "q_order"
    },
    {
      "calculate": "if(datum.type === 'Disagree' || datum.type === 'Strongly disagree', datum.percentage,0) + if(datum.type === 'Neutral', datum.percentage / 2,0)",
      "as": "signed_percentage"
    },
    { "stack": "percentage", "as": ["v1", "v2"], "groupby": ["question"] },
    {
      "joinaggregate": [
        {
          "field": "signed_percentage",
          "op": "sum",
          "as": "offset"
        }
      ],
      "groupby": ["question"]
    },
    { "calculate": "datum.v1 - datum.offset", "as": "nx" },
    { "calculate": "datum.v2 - datum.offset", "as": "nx2" }
  ],
  "width": 1000,
  "height": 500,
  "mark": "bar",
  "encoding": {
    "x": {
      "field": "nx",
      "type": "quantitative",
      "title": "Percentage",
      "scale": { "domain": [-100, 100] }
    },
    "x2": { "field": "nx2" },
    "y": {
      "field": "question",
      "type": "nominal",
      "title": "Question",
      "sort": {
        "field": "avg_score",
        "op": "min",
        "order": "descending"
      },
      "axis": {
        "offset": 5,
        "ticks": false,
        "minExtent": 60,
        "domain": false
      }
    },
    "color": {
      "field": "type",
      "type": "nominal",
      "title": "Response",
      "scale": {
        "domain": ["Strongly disagree", "Disagree", "Neutral", "Agree", "Strongly agree"],
        "range": ["#c30d24", "#f3a583", "#cccccc", "#94c6da", "#1770ab"],
        "type": "ordinal"
      }
    },
    "tooltip": [
      { "field": "question", "type": "nominal", "title": "Question" },
      { "field": "type", "type": "nominal", "title": "Response" },
      { "field": "value", "type": "quantitative", "title": "Count" },
      { "field": "percentage", "type": "quantitative", "title": "Percentage", "format": ".1f" }
    ]
  }
}
